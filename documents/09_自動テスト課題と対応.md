# 自動テスト課題と対応

## 1. 現状の課題

### 1.1 モデル定義とテストデータ作成の不整合

テストデータ作成スクリプト（`create_test_data.py`）とモデル定義の間に不整合があり、テスト実行時にエラーが発生していました。

1. **`Politician`モデルの問題**:
   - テストデータ作成スクリプトで`is_current=True`を設定していたが、`Politician`モデルにはこのフィールドが存在しない
   - 実際には`is_current`フィールドは`PoliticianParty`モデルに存在する

2. **`Topic`モデルの問題**:
   - テストデータ作成スクリプトで`level=0`と`is_active=True`を設定していたが、`Topic`モデルにはこれらのフィールドが存在しない
   - 実際には`category`と`status`フィールドを使用する必要がある

3. **`Statement`モデルの問題**:
   - テストデータ作成スクリプトで`content_summary`と`location`フィールドを設定していたが、`Statement`モデルにはこれらのフィールドが存在しない
   - 実際には`title`、`source`、`source_url`などのフィールドを使用する必要がある

### 1.2 認証関連の問題

APIエンドポイントが認証を要求するようになっていますが、テストでは認証トークンが設定されていないため、多くのテストが401 Unauthorizedエラーで失敗しています。

1. **認証トークンの未設定**:
   - ほとんどのAPIテストで認証トークンが設定されていない
   - `test_auth.py`のログインテストも失敗している

2. **認証システムの問題**:
   - ログイン処理自体が401エラーを返している可能性がある
   - 認証システムの設定やパスワードハッシュ化の問題が考えられる

### 1.3 テスト実行スクリプトの問題

テスト実行スクリプト（`run_tests.py`）にも問題があり、テストの実行が正常に行われていませんでした。

1. **pytestのコマンドラインオプション**:
   - `--cov=app --cov-report=term`オプションが認識されない問題
   - これにより、カバレッジレポートが生成されない

2. **データベースの状態管理**:
   - テスト間でデータベースの状態が引き継がれ、重複エラーが発生
   - テスト実行前にデータベースをリセットする処理が必要

## 2. 対応策

### 2.1 モデル定義とテストデータ作成の整合性確保

1. **`create_test_data.py`の修正**:
   - `Politician`モデル作成時に`is_current`を削除し、`status="active"`を追加
   - `Topic`モデル作成時に`level`と`is_active`を削除し、`slug`、`category`、`status`を追加
   - `Statement`モデル作成時に`content_summary`と`location`を削除し、`title`、`source`、`source_url`、`importance`を追加

### 2.2 認証関連の対応

1. **認証トークン取得フィクスチャの追加**:
   - `conftest.py`に`auth_token`フィクスチャを追加して、テスト用の認証トークンを取得
   - `auth_client`フィクスチャも追加して、認証済みのクライアントを提供

2. **テストファイルの修正**:
   - 各テストファイルを修正して、APIリクエスト時に認証トークンを設定
   - `Authorization: Bearer {token}`ヘッダーを追加

### 2.3 テスト実行スクリプトの改善

1. **pytestコマンドラインオプションの修正**:
   - `run_tests.py`のpytestコマンド実行部分を修正
   - 認識されないオプションを削除または修正

2. **データベースリセット処理の追加**:
   - テスト実行前にデータベースをリセットする処理を追加
   - `Base.metadata.drop_all(bind=engine)`と`Base.metadata.create_all(bind=engine)`を実行

## 3. 今後の課題

1. **認証システムの改善**:
   - ログイン処理が正常に動作するよう、認証システムを見直す
   - パスワードハッシュ化の問題を解決する

2. **テストカバレッジの向上**:
   - 現在のテストカバレッジを測定し、不足している部分を特定
   - 重要な機能やエッジケースに対するテストを追加

3. **テスト実行の効率化**:
   - テスト実行時間の短縮
   - 並列実行の検討

4. **CI/CD統合**:
   - テスト実行をCI/CDパイプラインに統合
   - テスト結果とカバレッジレポートの自動生成・保存