# トピックテストの問題と対応

## 概要

トピック関連テスト（`tests/test_api/test_topics.py`）の実行時に複数の問題が発生していました。このドキュメントでは、発生していた問題と対応内容をまとめます。

## 発生していた問題

1. **UNIQUE制約違反エラー**
   - エラーメッセージ: `UNIQUE constraint failed: topics.slug`
   - 原因: テスト用のトピックを作成する際に、既に同じスラッグのトピックが存在するため

2. **テストフィクスチャの問題**
   - テスト用のトピックを作成するフィクスチャ（`test_topics`）が毎回新しいトピックを作成しようとしていた
   - 既存のトピックを検索して再利用する処理がなかった

3. **APIエンドポイントの問題**
   - テストでは`category`パラメータを使用してフィルタリングを行っていたが、APIエンドポイントとサービス関数では`category`パラメータがサポートされていなかった

## 対応内容

1. **テストフィクスチャの修正**
   - 既存のトピックを検索して再利用する処理を追加
   - 新しいトピックを作成する際に一意の名前とスラッグを生成するように修正
   - トピック間の関連を作成する際に既存の関連を確認するように修正

2. **ユーザーフィクスチャの修正**
   - 一意のユーザー名とメールアドレスを生成するように修正
   - 既存のユーザーを検索して再利用する処理を追加

3. **APIエンドポイントとサービス関数の修正**
   - トピックサービスの`get_topics`関数を修正して、カテゴリによるフィルタリングをサポートするように修正
   - APIエンドポイントの`read_topics`関数を修正して、カテゴリによるフィルタリングをサポートするように修正

## 対応結果

- すべてのトピック関連テストが成功するようになりました（`test_get_topic_relations`はスキップされていますが、これはトピック関連エンドポイントが実装されていないためです）
- テスト一覧ドキュメントも最新の状態に更新されました

## 関連ファイル

- `tests/test_api/test_topics.py`: トピック関連テスト
- `app/models/topic.py`: トピックモデル
- `app/services/topic.py`: トピックサービス
- `app/api/v1/endpoints/topics.py`: トピックAPI
- `documents/11_テスト一覧.md`: テスト一覧ドキュメント

## 対応日時

- 2025年3月21日